---
uuid: 6a527df3-5d56-4647-85a2-278add6b72cb
---

# 자가 치유

Liferay Cloud의 자가 치유 기능은 서비스 또는 애플리케이션이 응답하지 않는지 여부를 감지하고 응답하지 않는 서비스를 복구하는 절차를 자동으로 시작합니다. 플랫폼은 프로브를 사용하여 서비스를 모니터링합니다.

## 프로브 사용 및 구성

Liferay Cloud는 애플리케이션을 관리하기 위해 함께 사용되는 두 가지 프로브를 제공합니다.

* Liveness Probe: 서비스가 실행 중인지 여부를 나타냅니다.
* 준비 상태 프로브: 서비스가 요청을 받을 준비가 되었는지 여부를 나타냅니다.

각 프로브는 다음 옵션으로 구성할 수 있습니다.

| 등록 정보 이름              | 묘사                                                                                                                                        |
|:--------------------- |:----------------------------------------------------------------------------------------------------------------------------------------- |
| `initialDelaySeconds` | 프로브가 시작되기 전에 컨테이너가 시작된 후 시간(초)입니다.                                                                                                        |
| `periodSeconds`       | 프로브를 수행할 빈도(초)입니다. 기본값은 10입니다. 최소값은 1입니다.                                                                                                 |
| `timeoutSeconds`      | 프로브가 시간 초과된 후 시간(초)입니다. 기본값과 최소값은 1입니다.                                                                                                   |
| `successThreshold`    | 실패 후 프로브가 성공한 것으로 간주되는 최소 연속 성공 횟수입니다. 기본값과 최소값은 `1`입니다. 활동성을 위해서는 `1` 이어야 합니다.                                                           |
| `failureThreshold`    | Liferay Cloud가 포기하기 전에 실패한 프로브를 반복하는 횟수입니다. 활동성 프로브의 경우 포기하면 서비스가 다시 시작됩니다. 준비 프로브의 경우 포기는 프로브가 실패로 표시됨을 의미합니다. 기본값은 `3`입니다. 최소값은 `1`입니다. |

프로브가 실패를 감지하면(즉, 상태 확인에서 성공 메시지를 반환하지 않음) 프로브는 자동으로 문제를 해결하기 위한 조치를 취합니다(서비스를 다시 시작하거나 트래픽을 인스턴스에서 다른 방향으로 리디렉션). 프로브 자체는 정전을 *일으키지 않지만* 자동으로 감지하고 대응하려고 시도합니다.

활성 및 준비 프로브는 환경에 관계없이 모든 서비스에 배포됩니다. 일반적으로 고객은 필요에 따라 값을 조정하지 않는 한 프로브를 변경할 필요가 없습니다. 예를 들어 시스템 관리자는 더 긴 시작 프로세스를 고려하여 `initialDelaySeconds` 값을 늘릴 수 있습니다.

기본값을 변경하려면 `lcp.json` 파일을 수정하십시오. [LCP.json을 통한 구성](../reference/configuration-via-lcp-json.md) 문서를 참조하세요.

## 활성도 프로브

활동성 프로브는 URL 요청(경로/포트)을 사용하여 서비스가 제대로 실행되고 있는지 확인합니다. 이 프로브는 구성 가능한 경로(예: `liferay` 서비스의 경우 `/c/portal/layout` )를 반복적으로 핑합니다. 종종 활성 프로브는 애플리케이션 내부의 경량 HTTP 서버입니다.

```{tip}
`liferay` 서비스(`/c/portal/layout`)에 대한 활성 프로브의 경로는 인스턴스의 홈 페이지(기본적으로 `/web/guest/home`)로의 리디렉션을 사용합니다. 리디렉션 프로세스는 프로브의 응답 시간에 추가되는 또 다른 요청을 추가합니다. 응답 시간을 줄이고 활동성 프로브의 효율성을 개선하려면 인스턴스의 페이지를 더 직접적으로 가리키도록 경로를 구성하십시오.
```

프로브가 200 또는 300 범위의 HTTP 응답을 받으면 애플리케이션을 정상으로 표시합니다. 서비스 컨테이너의 전체 수명 주기 동안 실행되며 인스턴스가 더 이상 작동하지 않는 경우(예: 충돌로 인해) 실패합니다.

프로브가 경로를 여러 번 ping하고( `LCP.json`에서 프로브의 `failureThreshold` 필드를 통해 구성 가능) 유효한 응답을 받을 수 없는 경우(프로브 실패) 서비스가 자동으로 다시 시작됩니다. 활동성 프로브가 실패하면 시작하는 동안 서비스에 문제가 있거나, 서비스가 충돌하여 복구되지 않거나, 프로브 구성에 대해 너무 느리게 응답하여 서비스를 조정해야 할 수 있음을 나타내는 신호입니다.

각 서비스의 `LCP.json` 파일에는 다음 구성이 포함됩니다.

```json
{
  "livenessProbe": {
    "httpGet": {
      "path": "/status",
      "port": 3000
    },
    "initialDelaySeconds": 40,
    "periodSeconds": 5,
    "successThreshold": 5
  }
}
```

### 활성도 프로브 구성 조정

활동성 프로브에 가장 적합한 구성은 배포한 사용자 지정과 서비스의 예상 시작 시간에 따라 다릅니다. `경로` 값은 서비스가 실행 중임을 가장 잘 나타내는 경로로 설정해야 합니다. `liferay` 서비스의 경우 이는 기본 사이트의 홈 페이지(예: `/web/guest/home`)에 대한 경로이거나 로드하는 데 더 오래 걸리는 탐색에서 숨겨진 페이지일 수 있습니다.

`liferay` 서비스의 경로는 일반적으로 적용될 수 있는 모듈 또는 사용자 지정으로 인해 경로 조정이 필요할 수 있는 유일한 서비스입니다. 예를 들어 사용자 정의 OSGi 모듈 또는 서블릿을 생성하여 서비스가 활성화되었다는 신호 요청을 수락하기 전에 다른 사용자 정의 모듈이 활성 상태인지 확인하는 대신 ping할 수 있습니다.

활성 프로브 구성의 다른 값(`initialDelaySeconds`, `periodSeconds`, `successThreshold`, `timeoutSeconds`및 `failureThreshold`)도 서비스의 일반 성능에 필요한 만큼 조정해야 합니다. `initialDelaySeconds` 값은 서비스 시작 예상 시간을 수용해야 합니다. 예를 들어 `liferay` 서비스가 시작 시 추가 작업을 실행하는 경우 활성 확인을 수행하는 데 더 많은 시간이 필요할 수 있습니다.

`timeoutSeconds` 및 `failureThreshold` 값은 서비스가 정지 상태에서 복구할 수 없고 다시 시작해야 한다고 가정해도 안전할 만큼 충분히 길어야 합니다. 이러한 값은 요청에 응답하는 서비스의 일반적인 성능에 적합하지 않은 경우 필요에 따라 조정해야 합니다.

사용자 정의(사용자 정의 모듈, 스크립트 등)가 가질 수 있는 서비스 시작 및 응답 시간에 미치는 영향을 인식하고 그에 따라 활동성 프로브의 구성을 조정해야 합니다. 구성하는 `initialDelaySeconds` 값은 시작에 실패하는 경우 적절한 시간 내에 서비스를 중지하고 다시 시작하는 데 유용해야 하지만 프로브가 서비스를 너무 빨리 다시 시작하여 성공적으로 시작할 수 없을 정도로 짧은 시간은 아닙니다. `timeoutSeconds`, `periodSeconds`, `failureThreshold` 는 서비스를 강제로 다시 시작하기 전에 복구하고 작업을 재개할 수 있는 충분한 시간을 서비스에 제공하기에 충분히 길어야 합니다(다시 시작하면 활동성 프로브의 원인을 찾는 데 방해가 될 수도 있음). 너무 빨리 발생하면 실패).

## 준비 프로브

준비 프로브는 활성 프로브와 같은 주소를 ping하거나 실행 가능한 명령을 사용하여 서비스의 가용성을 확인합니다. 명령이 올바른 종료 코드와 함께 반환되면 컨테이너가 정상으로 표시됩니다. 그렇지 않으면 비정상으로 표시되고 트래픽이 실패한 인스턴스에서 멀어집니다.

준비 프로브가 실패하면 구성된 명령을 수행할 때 서비스가 시간 초과되었다는 신호입니다. 이는 서비스가 너무 느리게 실행되고 조정이 필요하거나, 높은 트래픽을 수신하고 있어 모든 요청에 응답할 수 없거나, 실행 중인 명령에 문제가 있음을 나타낼 수 있습니다.

준비 프로브가 서비스가 준비되었음을 감지하는 즉시 서비스가 트래픽을 수신할 수 있습니다. 프로브가 서비스가 더 이상 준비되지 않았음을 감지하면 새 트래픽 수신을 중지합니다. 그러나 준비 프로브는 서비스를 다시 시작하지 않습니다. [활성 프로브](#liveness-probe) 서비스를 강제로 다시 시작합니다.

각 서비스의 `LCP.json` 파일에는 다음 구성이 포함됩니다.

```json
{
  "readinessProbe": {
    "exec": {
      "command": ["cat", "/tmp/healthy"]
    },
    "initialDelaySeconds": 40,
    "periodSeconds": 5
  }
}
```

다음은 `webserver` 서비스에 배포된 준비 프로브의 샘플 로그입니다. 로그는 Google 서버가 특정 경로 `nginx_status` 을 계속해서 방문하고 있음을 보여줍니다.

```shell
Oct 04 12:05:51.821 build-14 [webserver-5547c96447-hbrr6] 10.138.0.69 - - [04/Oct/2019:19:05:51 +0000] "GET /nginx_status HTTP/1.1" 200 117 "-" "kube-probe/1.12+" "-"
Oct 04 12:05:53.001 build-14 [webserver-5547c96447-hbrr6] 10.138.15.249 - - [04/Oct/2019:19:05:53 +0000] "GET /nginx_status HTTP/1.1" 200 115 "-" "GoogleHC/1.0" "-"
Oct 04 12:05:53.083 build-14 [webserver-5547c96447-hbrr6] 10.138.0.13 - - [04/Oct/2019:19:05:53 +0000] "GET /nginx_status HTTP/1.1" 200 115 "-" "GoogleHC/1.0" "-"
Oct 04 12:05:53.293 build-14 [webserver-5547c96447-hbrr6] 10.138.15.251 - - [04/Oct/2019:19:05:53 +0000] "GET /nginx_status HTTP/1.1" 200 115 "-" "GoogleHC/1.0" "-"
```

### 준비 프로브 구성 조정

준비 프로브는 요청을 수신하기 위해 서비스의 가용성을 적절하게 측정하는 명령을 실행해야 합니다. 서비스 인스턴스가 요청에 너무 느리게 응답하고 더 많은 트래픽에서 차단되어야 하는 경우(가능한 경우 다른 인스턴스로 리디렉션) 구성된 실행 가능 명령도 적절하게 응답할 수 있도록 이러한 속도 저하를 경험해야 합니다. `webserver`과 같은 서비스는 기본적으로 서비스 준비 상태를 확인하기 위해 특정 주소만 핑합니다. 그러나 서비스의 응답성을 확인하기 위해 사용자 지정 스크립트를 실행하는 것과 같이 다른 명령을 생성할 수 있습니다.

필요한 경우 필요에 따라 다른 구성 값(`initialDelaySeconds`, `periodSeconds`, `timeoutSeconds`및 `successThreshold`)도 조정해야 합니다. 서비스가 그렇게 하는 데 오랜 시간이 걸리더라도 더 많은 요청을 처리하는 것을 선호하는 경우(예: 요청을 처리하기 위해 수행된 작업에 오랜 시간이 걸릴 것으로 예상되는 경우) 구성에서 더 긴 시간 제한을 허용해야 합니다. 서비스가 요청에 신속하게 응답하거나 대신 시간 초과되어야 하는 경우 구성의 시간 초과가 더 짧아야 합니다.
