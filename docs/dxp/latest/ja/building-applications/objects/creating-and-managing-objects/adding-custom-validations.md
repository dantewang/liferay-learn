# カスタムバリデーションの追加

{bdg-secondary}`Liferay 7.4 U27以降とGA27以降で利用可能`

カスタムオブジェクトで、カスタムフィールドとメタデータフィールドの両方にバリデーションを追加できます。 バリデーションは有効なフィールドエントリーを決定するために使用されるルールを設定し、[Groovy](https://groovy-lang.org/)スクリプト、またはLiferayの[式ビルダー](./expression-builder-validations-reference.md)を使って定義されます。 各バリデーションには、独自のトリガー、条件、エラーテキストがあり、オブジェクトUIから設定することができます。 バリデーションが開始されると、定義した条件に従ってフィールドエントリーが有効かどうかがチェックされ、無効なエントリーに対してはエラーテキストが表示されます。

![カスタムおよびメタデータのオブジェクトフィールドのバリデーションを作成します。](./adding-custom-validations/images/01.png)

```{note}
バリデーションを作成する前に、必要なデータフィールドが存在する必要があります。
```

以下の手順で、カスタムバリデーションを追加します。

1. *グローバルメニュー* （![Global Menu](../../../images/icon-applications-menu.png)）を開き、*［コントロールパネル］ *タブをクリックして、 *［オブジェクト］ *に進みます。

1. カスタムオブジェクトの編集を開始します。

1. *［Validations］*タブに移動し、*追加*ボタン（![Add Button](../../../images/icon-add.png)）をクリックします。

1. *ラベル*を入力し、バリデーションタイプ、つまり*Groovy* または *式ビルダー*を選択します。

   ![ラベルを入力し、入力値の検証タイプを選択します。](./adding-custom-validations/images/02.png)

1. *［Save］*をクリックします。

1. 新しく作成したバリデーションの編集を開始します。

1. *［Conditions］*タブに移動して、バリデーションに条件を追加します。

   ![バリデーションに条件を追加します。](./adding-custom-validations/images/03.png)

   Groovyを使用する場合、サイドパネルから利用可能なデータフィールドを参照し、条件に追加することができます。 詳細は、[Groovyバリデーションの使用](#using-groovy-validations)を参照してください。

   式ビルダーを使用する場合、サイドパネルからフィールド、演算子、関数を参照し、条件に追加できます。 詳細は、 [式ビルダーバリデーションの使用](#using-expression-builder-validations) を参照してください。

   ```{tip}
   条件には、複雑な検証をするための複数のフィールドや関数を含めることができます。
   ```

1. ローカライズ可能な *エラーメッセージを入力します*。 このメッセージは、バリデーションが開始され、フィールドエントリーが1つ以上の定義された条件を満たさない場合に表示されます。

1. *［Basic Info］* タブを開き、バリデーションを*有効に*します。

1. *［Trigger Event］* を選択し、フィールドエントリーに対して入力値の検証が実行されるタイミングを決定します。

   ```{note}
   各検証は、1つのトリガーイベントしか持つことができません。
   ```

   ![バリデーションを有効にし、トリガーイベントを設定します。](./adding-custom-validations/images/04.png)

1. *［Save］*をクリックします。

有効にすると、すべての新規オブジェクトエントリーに対して検証が実行されます。

## Groovyバリデーションの使用

Groovyバリデーションタイプは、標準Groovyスクリプト機能をすべてサポートしています。 ただし、Groovyの条件を定義する場合は、 `invalidFields` 変数を使用します。 Liferayは`invalidFields`が`true`を返す場合にのみ、確認エラーメッセージを表示します。

![サイドパネルを使用して、Groovyバリデーションにフィールド要素を追加します。](./adding-custom-validations/images/05.png)

Liferay 7.4 U33+とGA33+では、Liferayは[GroovyShellクラス](https://docs.groovy-lang.org/latest/html/api/groovy/lang/GroovyShell.html)を使って、*［保存］*をクリックしたときにGroovy スクリプトの構文が有効であるかどうかをチェックします。 スクリプトが無効な場合、Liferayはエラーメッセージを表示します。

## 式ビルダーバリデーションの使用

式ビルダータイプには、規定値フィールド、演算子、関数が用意されており、要素サイドパネルでアクセスすることができます。 要素をクリックすると、その要素が条件エディタに追加されます。 これらの関数は、ブール値を返します。 提供される演算子や関数の完全なリストについては、 [式ビルダーバリデーションのリファレンス](./expression-builder-validations-reference.md) を参照してください。

```{important}
式ビルダーバリデーションは、テキスト、数値、日付、ブール値の各フィールドタイプでのみ使用可能です。
```

![サイドパネルを使用して、フィールド、演算子、関数の要素をバリデーションに追加します。](./adding-custom-validations/images/06.png)

Liferay 7.4 U33+とGA33+では、*［保存］*をクリックすると、Liferayは式が有効な構文であるかどうかをチェックします。 式が無効な場合、Liferayはエラーメッセージを表示します。

## 利用可能なフィールドのリファレンス

条件を作成する際、オブジェクトのカスタムフィールドやメタデータフィールドのいずれかを使用できます。 また、リレーションシップの「片側」のリレーションシップフィールドから選択することも可能です。

次の表は、カスタムオブジェクトに含まれるすべてのデフォルトのメタデータフィールドの一覧です。

| 項目                      | 説明                     |
|:----------------------- |:---------------------- |
| `companyId`             | エントリーが作成されたポータルインスタンス  |
| `createDate`            | エントリーが作成された日時          |
| `externalReferenceCode` | エントリーの外部参照コード          |
| `groupId`               | エントリーが作成されたサイトID       |
| `lastPublishDate`       | エントリーが最後に公開された日付       |
| `modifiedDate`          | エントリーが最後に更新された日付       |
| `mvccVersion`           | エントリーのMVCCバージョン        |
| `objectDefinitionId`    | エントリーのオブジェクトのID        |
| `objectEntryId`         | エントリーのID               |
| `status`                | エントリーのワークフローステータス      |
| `statusByUserId`        | ワークフローで割り当てられたユーザーのID  |
| `statusByUserName`      | ワークフローで割り当てられたユーザーの名前  |
| `statusDate`            | ワークフローステータスが最後に更新された日付 |
| `userEmailAddress`      | エントリー作成者のメールアドレス       |
| `userFirstName`         | エントリー作成者の名             |
| `userId`                | エントリー作成者のID            |
| `userLastName`          | エントリー作成者の姓             |
| `userName`              | エントリー作成者のユーザー名         |
| `uuid`                  | エントリーの重複しないユニバーサルID    |

```{note}
カスタムフィールドの他に、以下のメタデータフィールドが編集サイドバーに一覧表示され、簡単にアクセスできるようになっています。

* 作成者 (`userName`)
* 作成日 (`createDate`)
* ID (`objectEntryId`)
* 編集日時 (`lastPublishDate`)
* ワークフローステータス (`status`)
```

## 式ビルダーの演算子

次の表は、式ビルダーの検証で利用できる演算子の一覧です。

| 演算子                | 説明                    |
|:------------------ |:--------------------- |
| And ( `AND` )      | 依存した関係を表すのに使用される等位接続詞 |
| Divided By ( `/` ) | 除算の数学演算子              |
| Minus ( `-` )      | 除算の数学演算子              |
| Or ( `OR` )        | 独立した関係を表すのに使用される等位接続詞 |
| Plus ( `+` )       | 加算の数学演算子              |
| Multiply ( `*` )   | 乗算の数学演算子              |

## 式ビルダーの関数

次の表は、利用可能な式ビルダー関数と互換性のあるフィールドタイプの一覧です。

| 演算子                         | テキストフィールド | 数値フィールド  | 日付フィールド  |
|:--------------------------- |:--------- |:-------- |:-------- |
| Compare Dates               |           |          | &#10004; |
| Concat                      | &#10004;  |          |          |
| Condition                   | &#10004;  | &#10004; | &#10004; |
| Contains                    | &#10004;  | &#10004; |          |
| Does Not Contain            | &#10004;  | &#10004; |          |
| Future Dates                |           |          | &#10004; |
| Is a URL                    | &#10004;  |          |          |
| Is an Email                 | &#10004;  |          |          |
| Is Decimal                  |           | &#10004; |          |
| Is Empty                    | &#10004;  |          |          |
| Is Equal To                 | &#10004;  | &#10004; |          |
| Is Greater Than             |           | &#10004; |          |
| Is Greater Than or Equal To |           | &#10004; |          |
| Is Integer                  |           | &#10004; |          |
| Is Less Than                |           | &#10004; |          |
| Is Less Than or Equal To    |           | &#10004; |          |
| Is Not Equal To             | &#10004;  | &#10004; |          |
| Match                       | &#10004;  |          |          |
| Past Dates                  |           |          | &#10004; |
| Range                       |           |          | &#10004; |
| Sum                         |           | &#10004; |          |

## 追加情報

* [オブジェクトの作成](./creating-objects.md)
* [オブジェクトへのフィールドの追加](./adding-fields-to-objects.md)
* [式ビルダーバリデーションのリファレンス](./expression-builder-validations-reference.md)
