# 低レベル検索オプションを理解する

> 低レベル検索は [Elasticsearch](../../installing-and-upgrading-a-search-engine/elasticsearch.html)でのみ動作します。

低レベル検索は、Liferayの検索インデックスでドキュメントを検索するためのインフラであるSearch and Indexing Frameworkを経由しません。

低レベル検索の一般的な使用例は、Liferay DXPインデックス以外のインデックスを照会することです。 デフォルトでは、 [ページの検索](../working-with-search-pages/search-pages.md) はLiferay DXPのインデックスを検索しますが、同じElasticsearchクラスタ内であれば、別のインデックスを検索することもできます。

低レベル検索オプションウィジェットを検索ページに追加し、代替インデックスに検索を誘導するように設定します。 同じページから複数のインデックスを検索するには、複数の低レベル検索オプションウィジェットを追加し、それぞれにインデックス名と統合検索キーを設定します。

代替インデックスの検索は、Liferay DXPのパーミッションチェック機構をバイパスする低レベルの操作で、検索エンジンが返す結果をすべて提示します。 このため、低レベル検索オプションウィジェットを追加・設定できるのは管理者のみです。

低レベル検索オプションウィジェットを使用するには、［検索ページ］に追加します。

1. ページ上の追加アイコン(![Add app icon](../../../images/icon-add-widget.png)）をクリックすると、［Add Widgets］メニューが表示されます。

   ![低レベル検索オプションウィジェットは、検索ウィジェットの下にあります。](./understanding-low-level-search-options/images/01.png)

1. 検索セクションの低レベル検索オプションウィジェットをドラッグして、ページにドロップします。

1. オプションアイコン(![Options icon](../../../images/icon-app-options.png)）をクリックし、*［設定］*をクリックします。

   ![設定リンクをクリックすると、ウィジェットの設定画面が表示されます。](./understanding-low-level-search-options/images/02.png)

ウィジェットには様々なオプションが設定されています。

**[Liferay 7.3+]接続ID：** 検索に使用する接続の接続IDを選択します。

**インデックス：** 検索する代替インデックスの名前をコンマで区切って入力します。 通常、Liferayの会社のインデックス名を入力するべきではありません。

**返すフィールド：** 検索エンジンから返される保存されたフィールドの名前をカンマ区切りで入力します。 空白にすると、保存されているすべてのフィールドが返されます。

**含める貢献者：** この検索に含める登録済みの貢献者のIDを、各 `SearchRequestContributor`の完全修飾クラス名(例： `com.liferay.docs.request.contributor.MySearchRequestContributor`）をカンマで区切って入力します。 設定されていない場合は、登録されているすべての検索貢献者が適用されます。

**除外する貢献者：** この検索から除外する登録済みの検索協力者のIDをカンマで区切って入除外除外除外除外力してください。 設定されていない場合は、登録されているすべての検索協力者が適用されます。

```{note}
これらの*貢献者*は、`com.liferay.portal.search.spi.searcher.SearchRequestContributor`インターフェイス(`com.liferay.portal.search.spi`アーティファクトで提供される）を実装したコンポーネントであり、検索リクエストをインターセプトし、クエリパーツを追加する拡張ポイント(SPI）である。
```

**統合検索キー：** このウィジェットが参加している代替検索のキーを入力します。 設定されていない場合、このウィジェットはデフォルトの検索に参加します。 この値は通常、アプリケーション定義のインデックスの名前です。

**[Liferay 7.4以降] 属性：** 検索コンテキストにキー/バリュー属性を追加します。 このセクションは、 [検索ブループリン](../../liferay-enterprise-search/search-experiences/search-blueprints/using-a-search-blueprint-on-a-search-page.md)をページの検索に適用する場合に最も有用です。 また、開発やテストの目的でも使用できます。カスタムコードで読み取れる属性をページの検索コンテキストに追加します(例： `searchContext.getAttribute("key")`）。

## 低レベルの検索結果を表示する

Liferay社のインデックスに登録されているアセット(例： `liferay-20097`）は、 `ModelSummaryContributor` を実装して、検索結果ウィジェットで使用される独自の表示ロジックを提供することができます。 低レベルの検索では、サマリーがないため、表示ロジックが異なります。

* フィールドが1つしか設定されていない場合、そのフィールドはタイトルフィールドとして表示されます(大きくて太いテキストが表示されます）。
* 2つのフィールドが存在する場合、1つ目はタイトル(大きくて太いテキスト）として使用され、2つ目は説明フィールドとなります。
* 2つ以上のフィールドが存在する場合は、最初のフィールドがタイトルフィールドとして使用され(大きな太字で表示されます）、残りのフィールドは説明フィールドとしてマッシュアップされます。

![低レベルサーチフレームワークには、魅力的な結果サマリーをその場で作成するロジックが含まれています。](./understanding-low-level-search-options/images/04.png)

## 低レベルサーチとパーミッションチェック

低レベル検索では、パーミッションチェックはできません。 低レベル検索を使って企業のインデックスまで検索してしまうと、重要な [権限チェック](../search-results/search-results-behavior.md#permissions-and-search-results) が回避されてしまいます。 ほとんどの場合、権限チェックのメリットを求めますが、意図的に権限チェックを回避するユースケースとして考えられるのは、管理者専用の検索ページで、検索ページにアクセスする人は会社のインデックスにあるすべての結果にアクセスできなければならない場合です。

## 低レベルの検索と関連性

関連性スコアリングは、インデックスの中でのみ意味を持ちます。 別々のインデックスから得られた結果は、お互いに正確なスコアリングができません。 そのため、各インデックスからの結果を別の「検索結果」ウィジェットに表示するのがベストです。 以下の例では、そのことを示しています。

## 例1：代替インデックスの検索

1. デフォルトの検索ページでテストする場合も、新しい [検索ページ](../working-with-search-pages/search-pages.md)を作成する場合も、以下のウィジェットを含めてください(余分なウィジェットを削除すると、練習が簡単になりますが、動作には必要ありません）。

    * 低レベル検索オプション
    * カスタムフィルター
    * 検索バー
    * 検索結果

1. オプションアイコンをクリックして(![Options icon](../../../images/icon-app-options.png)）、 *［設定］*を選択して、すべてのウィジェットが代替検索に参加するように設定します。 それぞれ、統合検索キーの設定に、 *liferay-0* と入力します。

   代替検索に適切に反応することが期待されるすべての検索ウィジェットには、統合検索キーが設定されている必要があります。

1. 低レベル検索オプションウィジェットで追加設定を行い、代替インデックスのインデックス名を追加します。

   *インデックス* の設定で、少なくとも1つのインデックス名を入力します。 この例に従うには、 *liferay-*使用します。

1. 検索バーのデフォルトのクエリパラメータ(*q*)を使用するようにカスタムフィルタを設定し、検索にクエリを追加します。

   カスタムパラメーター名に _q_ と入力します。

   フィルタフィールドに _title_ と入力すると、クエリにタイトルフィールドが追加されます。

   フィルタークエリタイプで_Match_ を選択します。

   デフォルトのクエリをオーバーライドして代替インデックスを検索しているので、デフォルトではクエリには何もありません。 検索エンジンに送信したいクエリ句は、 [カスタムフィルター](./filtering-search-results.md) ウィジェットを使って手動で追加する必要があります。

   ```{important}
   検索バーのキーワードパラメータ名設定のデフォルト値に合わせて、カスタムパラメータ名を`q`に設定します。 マッチング・パラメータは、検索バーに入力されたユーザーのキーワードがカスタム・フィルタ・ウィジェットに適用されるようにします。 検索バーのキーワードパラメータ名にカスタム値が設定されている場合は、`q`の代わりにその値を使用します。
   ```

ここでの例のように、 *liferay-0*を検索する場合は、検索バーで *dynamic* を検索します。 このような結果が出てきます：

![低レベル検索による結果の例](./understanding-low-level-search-options/images/03.png)

## 例2：Liferayカンパニーインデックスと追加インデックスの検索

[ページの検索](../working-with-search-pages/search-pages.md)を設定し、Liferayの会社インデックス(例：liferay-20098）から1組の結果と、LiferayのElasticsearchクラスターで代替のインデックスからの結果のセットを表示します(この例ではデモのために liferay-0 を使っています）。

1. これらのウィジェットを_低レベル検索_ [という名前の新しいページに追加します ](./../../../site-building/creating-pages/using-widget-pages/adding-widgets-to-a-page.md)：

   * 1つの低レベル検索オプション
   * 2つの [検索バー](../../getting-started/searching-for-content.md#using-the-search-bar)
   * 2つの[検索結果 ](./configuring-the-search-results-widget.md)
   * 1つの [カスタムフィルター](./filtering-search-results.md)

   ```{tip}
   この例では、1-2-1 Column (50/50) [page layout](./../../../site-building/creating-pages/page-settings/configuring-individual-pages.md#page-layout)が便利です。
   ```

1. ウィジェットの設定を行います。

   | 検索ウィジェット    | ウィジェット設定                                                                                                                                                               | 説明                                                                                                                                                                   |
   | ----------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | 低レベル検索オプション | **インデックス：** `liferay-0`<br />**統合検索キー:** `liferay-0`                                                                                                             | これにより、代替インデックスの検索が設定されます。 ここでは、デモ目的のために、Liferayが管理する別のインデックスを使用しています。 統合検索キーは、任意の覚えやすい文字列です。 この例では、1つの追加インデックスのみを検索するので、インデックス自体と同じ名前になっています。                        |
   | 検索結果(最初）    | -                                                                                                                                                                      | 検索結果ウィジェットは、Liferayの企業インデックス用にあらかじめ設定されていますので、これはすべてデフォルトのままで構いません。                                                                                                  |
   | 検索結果(秒）     | **統合検索キー：** `liferay-0`                                                                                                                                                | また、どのフィールドを表示するかなどの設定も可能です。 このオプションを空白にすると、 [Liferayがそれを理解するように要求されます](#displaying-low-level-search-results).                                                        |
   | 検索バー(最初）    | -                                                                                                                                                                      | 最初の検索バーは、会社のインデックスを検索するように設定されているので、デフォルトのままにしておきます。                                                                                                                 |
   | サーチバー(2番目）  | **不可視：** `true`<br />**統合検索キー:** `liferay-0`                                                                                                                     | ユーザーの入力に使用されるのは1つの検索バーだけなので、この検索バーは非表示にする必要があります。 重要なのは、両方の検索バーウィジェットで「キーワードパラメータ名」のデフォルト値を残したことです。 この検索バーは、ページに表示されている検索バーとパラメータを共有しているため、ユーザーが入力した検索語を取り込むことができます。 |
   | カスタムフィルター   | **フィルターフィールド：** `title_en_US`<br />**発生：** `should`<br />**Custom Parameter Name:**`q`<br />**Invisible：** `true`<br />**統合検索キー:** `liferay-0` | カスタムフィルターウィジェットは、 `liferay-0` インデックスのタイトルフィールドと一致する必要があります。 より多くのフィルターを使用したい場合は、カスタムフィルターウィジェットを追加してください。                                                            |

   ```{important}
   検索バーのキーワードパラメータ名設定のデフォルト値に合わせて、カスタムパラメータ名を`q`に設定します。 マッチング・パラメータは、検索バーに入力されたユーザーのキーワードがカスタム・フィルタ・ウィジェットに適用されるようにします。 検索バーのキーワードパラメータ名にカスタム値が設定されている場合は、`q`の代わりにその値を使用します。
   ```

低レベル検索ページの機能を試すには、

1. サイト内に少なくとも1つのアセット(Blogエントリー、Webコンテンツ記事など）を追加し、作成したアセットには _コンテンツ_ という単語を入れてください。

1. 低レベル検索ページの検索バーに、 _content_ と入力し、両方のインデックスから結果が得られることを確認します。

![別々のインデックスからの結果は、別々の検索結果ウィジェットに表示するのが最適です。](./understanding-low-level-search-options/images/05.png)

これで、クラスタ内の任意のElasticsearchインデックスに対する検索に参加するために、すぐに使える検索ウィジェットを設定できるようになりました。
