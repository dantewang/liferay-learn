# 検索ブループリントの作成と管理

グローバルメニューのアプリケーションセクション &rarr; Search Experiences から [Search Blueprints](./understanding-search-blueprints.md) を作成することができます。 もし既にブループリントを持っていて、その機能をLiferay [ページの検索](../../../search-pages-and-widgets/working-with-search-pages.md)に適用したい場合は、 [検索ブループリントを検索ページで使用する](./using-a-search-blueprint-on-a-search-page.md) をご覧ください。

検索ブループリントを作成するには、

1. ［グローバルメニュー］ &rarr; ［アプリケーション］ (Search Experiences) から ［**ブループリント**］ をクリックして、ブループリントアプリケーションを開きます。

1. **Add**(![Add](../../../../images/icon-add.png)) をクリックして、ブループリントを追加します。

   ![［ブループリントの追加］モーダルウィンドウからブループリントの作成を開始します。](./creating-and-managing-search-blueprints/images/01.png)

1. ［新規検索ブループリント］ウィンドウで、ブループリントに［name］ (必須) と［description］(オプション) を指定します。

1. ブループリントの計画に応じて、次にこれらのメニューを使用して [ブループリント](./understanding-search-blueprints.md#what-is-a-blueprint) の構築を継続することになります。

   - [クエリビルダー](#using-the-query-builder) ：クエリ要素セクションで、ブループリントの要素を選択または作成して、検索に新しいクエリー条件を追加します。 クエリ設定セクションで、クエリの追加設定(検索するアセットタイプやオブジェクトタイプなど）を行います。

   - [設定](#adding-configurations) ：検索における詳細設定(ソートや集計など）を行います。

1. ブループリントを構築し、構成しながらテストします。 ［**プレビュー**］ をクリックし、検索キーワードを入力してください。

   ![ブループリントを実行する前にプレビューすることができます。](./creating-and-managing-search-blueprints/images/02.png)

   詳しくは、 [Testing a Blueprint](#testing-a-blueprint-with-the-preview-sidebar) を参照してください。

1. 最初のブループリントの作成が完了したら、 ［**保存**］ をクリックします。

ブループリントの作成プロセスは、迅速かつシンプルに行うことができますが、時には繰り返しやテストが必要になることもあります。 ブループリントを頻繁に保存して、作業内容を確実に保存してください。

ブループリントの編集や削除は、その［アクション］メニュー(![Actions](../../../../images/icon-actions.png)）から行います。

[また、](#importing-and-exporting-blueprints) Search Blueprint のインポートおよびエクスポートが可能です。

![ブループリントのアクションメニューから編集、削除、エクスポートを行うことができます。](./creating-and-managing-search-blueprints/images/03.png)

## クエリビルダーの使用

クエリビルダーの使用して

1. [ブループリントに要素を追加](#adding-elements-to-the-blueprint) .

1. [どのLiferayアセットを検索するかを選択](#choosing-which-liferay-assets-to-search) .

### ブループリントに要素を追加する

要素を追加してブループリントにクエリ句の追加を開始します。

1. クエリ要素画面の **追加**(![Add](../../../../images/icon-add.png)) をクリックして、クエリ要素の追加サイドバーを開きます。

   ![ブループリントに要素を追加します。](./creating-and-managing-search-blueprints/images/04.png)

1. 探索したい要素カテゴリを展開する。

1. 要素」にカーソルを合わせ、「**追加**」 をクリックします。

1. この要素は、［Query Builder］に追加され、設定できるようになります。

   ![この要素は、検索ユーザーが所属しているサイトのコンテンツを10ブーストします。](./creating-and-managing-search-blueprints/images/05.png)

1. 検索クエリを設定するために必要な数の要素を追加します。

   既成の各要素の説明については、 [検索ブループリント要素のリファレンス](./search-blueprints-elements-reference.md) を参照してください。

1. カスタム要素が必要な場合は、クエリビルダーにカスタムJSON要素を追加し、必要なクエリ句を記述します。

   カスタムJSON要素の作成については、 [エレメントを作る](./creating-and-managing-elements/creating-elements.md) を参照してください。

```{important}
一部の要素は、Query Builderでブループリントに追加する以上のアクションが必要です。 例えば、Boost Longer Contents 要素または Boost Contents with More Versions 要素を使用するには、コントロールパネル &rarr; Search &rarr; Index Actions で以下のエントリーのインデックスを再作成する必要があります：


* `com.liferay.blogs.model.BlogsEntry`
* `com.liferay.document.library.kernel.model.DLFileEntry`
* `com.liferay.journal.model.JournalArticle`
* `com.liferay.knowledge.base.model.KBArticle`
* `com.liferay.wiki.model.WikiPage`

その他の要素にはジオロケーション機能(例:、ブースト・プロキシミティ）。 詳しくは、[要素リファレンス](./search-blueprints-elements-reference.md)をご覧ください。
```

要素を追加した後、ブループリントを保存していることを確認してください。

### どのLiferayアセットを検索するかを選択

ブループリントのクエリにどのLiferayアセットタイプを含めるかを決定します。 ［クエリ設定］ &rarr; ［Searchable Types］を使用します。

![検索可能なタイプ］ドロップダウンを展開し、［検索ブループリント］からアセットの削除を開始します。](./creating-and-managing-search-blueprints/images/06.png)

- デフォルトでは、すべてのアセットタイプとオブジェクトタイプが選択されています。
- 特定のタイプを削除するには、 **Select Asset Types** をクリックして Select Types を開き、対応するチェックボックスの選択を解除します。

![［タイプを選択］モーダルは、検索対象となる資産を一括管理するために使用します。](./creating-and-managing-search-blueprints/images/07.png)

```{note}
サーチブルタイプ］モーダルですべてのアセットを選択解除すると、すべてのタイプを選択したのと同じように、すべてのアセットとオブジェクトのタイプが検索されます。 Liferayの検索句のほとんどを無効にする方法については、 [クエリ句のコントリビューターを設定する](#advanced-configuring-query-clause-contributors) をご覧ください。
```

［Searchable Types］の設定を編集した後は、必ずブループリントを保存してください。

［Searchable Types］設定でアセットタイプを無効にすると、通常そのインデックス作成コードによって提供されるクエリ句が除外されることになります。 このタイプは検索できないので、ブループリントを検索に適用しても、エンドユーザーには除外されたタイプの結果が表示されません。

検索可能なタイプの設定は、他の条項貢献者設定オプションに重要な影響を与えるため、詳細な情報は以下に表示されます。

### 詳細：クエリ句のコントリビューターを設定する

Liferayのバックエンドコード(およびLiferayインスタンスにデプロイされたカスタムアプリケーションの可能性もあります）は、進行中の検索にクエリ句を提供します。

バックエンドから寄与されるこれらの条項は、Search Blueprintsによって設定することができます。 しかし、ほとんどのユーザーは、2つの設定に触れることはないはずです：

- 検索フレームワークのインデクサー条件
- 検索フレームワークのクエリコントリビューター

通常はデフォルトの設定で十分です。 [Searchable Types](#choosing-which-liferay-assets-to-search) を使う以上に、この動作を微調整しなければならないと確信しているのであれば、これらのバックエンド・コントリビューターの動作方法を理解する必要があります：

1. ［**検索可能なタイプ**］ を使用すると、個々のインデクサが検索に参加できないようにすることができます。 型のインデクサーを無効にすると、その型のクエリ・コントリビューターが選択されていても、その型のクエリが検索クエリに追加されることはない。 これらのタイプの結果は、ユーザーには表示されません。

1. ［**検索フレームワークのインデクサー条件**］ を使って、Liferayのすべてのインデクサが検索に句を提供しないようにします。 すべてのインデクサを無効にする唯一の理由は、検索クエリをゼロから構築し、すべてのクエリコントリビューターと検索可能なアセットを同様に無効にすることです。

1. ［**Search Framework Query Contributors**］ セクションを使用して、特定のコントリビューターを検索に参加させないようにすることができます。 独自のBlueprintsの設定を使って上書きしたい場合は特定の条項の貢献者を無効にし、Liferayの検索動作を完全に上書きしたい場合はすべての条項を無効にし、LiferayのIndexersとSearchable Typesも同様に無効にします。

```{important}
* すべてのインデクサと条件コントリビューターを無効にした場合でも、Liferayの検索フレームワークによって特定の必須句が常に追加されます。 そのため、ブループリントでクエリを一から作ることはありません。

* Liferayのインデクサフレームワークは Liferay 7.2でリファクタリングされました。 Webコンテンツ記事やフォルダなど、Liferayのコア資産の中には、新しいパターンに更新されていないものがあります。 これは、これらのアセットにはクエリコントリビュータが存在しないため、検索ブループリントに影響を及ぼします。 そのため、Liferay Indexer Clausesを有効にすると、常にアセットの標準的な条項が検索クエリに追加されます。 したがって、Webコンテンツ記事の句を完全にオーバーライドすることはできません。 しかし、これらの資産の検索動作は、より多くの節を重ねることで微調整することができます(例えば、特定の節の一致を高めるなど）。

* 内部的な制限により、Liferayの `Indexer`s をすべて有効にするか無効にするかを選択する必要があります。 他の条件コントリビューターは、より柔軟に管理できます。すべてのコントリビューターを含めるか、まったく含めないか、または希望するコントリビューターのサブセットを選択します。

![特定の句のコントリビューターまたはすべてのインデクサが検索クエリに句を貢献することを無効にします。](./creating-and-managing-search-blueprints/images/08.png)
```

条件コントリビューターやインデクサー動作を編集したら、必ずブループリントを保存してください。

## 構成の追加

検索クエリを細かく設定するだけでなく、検索ブループリント設定を追加すると、次のようなJSON設定が追加されます。

- 集計
- ハイライト
- ソート
- パラメーター
- 詳細設定

![追加設定はJSONを使用して設定することができます。](./creating-and-managing-search-blueprints/images/09.png)

これらを追加するには、 **Configuration** タブをクリックし、目的のコンフィギュレーションのテキストエントリーボックスを見つけます。 JSONを入力し、ブループリントを保存します。

以下は、検索結果を `name` フィールドで降順(アルファベット逆順--Z-A）にソートするソートの例です。

```json
{
    "sorts": [
        {
            "title_sortable": "desc"
        }
    ]
}
```

詳しくは [検索 ブループリント コンフィギュレーション リファレンス](./search-blueprints-configuration-reference.md) をご覧ください。

## ブループリントのインポートとエクスポート

ブループリントは、JSONオブジェクトです。 ある環境からブループリントのJSONをエクスポートして、別の環境にインポートします。 これは、ステージングおよびテスト環境から本番環境にブループリントを移行する際に便利です。

ブループリントのJSONをエクスポートするには。

1. ［グローバルメニュー］ &rarr; ［アプリケーション］ &rarr; ［ブループリント］(［Search Experiences］セクション) からブループリントアプリケーションを開いてください。

1. ブループリントの一覧から、ブループリントの **アクション**(![Actions](../../../../images/icon-actions.png)) メニューを開き、 **エクスポート** をクリックします。

ブループリントのJSON定義をインポートする。

1. ［グローバルメニュー］ &rarr; ［アプリケーション］ &rarr; ［ブループリント］(［Search Experiences］セクション) からブループリントアプリケーションを開いてください。

1. メインのブループリント **アクション**(![Actions](../../../../images/icon-actions.png)) メニューを開き、 **インポート** をクリックします。

1. 有効なBlueprint JSONファイルを選択します。 有効な要素のJSONファイルもこの画面からインポートすることができます。

   ![ブループリントと要素をインポートします。](./creating-and-managing-search-blueprints/images/10.png)

1. ［**Import**］ クリックします。

## プレビューサイドバーでブループリントをテストする

実行中のブループリントに裏付けされた検索結果を調べるのに便利なプレビューサイドバーがあります。 ブループリントの編集画面から ［**プレビュー**］ ボタンをクリックすることでプレビューにアクセスできます。

![ブループリントを実行する前にプレビューすることができます。](./creating-and-managing-search-blueprints/images/14.png)

ここでは、これらの機能にアクセスできます。

- 7.4 U52+の場合、 ［**生のリクエストを表示**］ をクリックすると、検索リクエスト文字列全体が表示されます。 ［Raw Request］モーダルから、リクエストをクリップボードにコピーするか、JSONファイルとしてダウンロードすることができます。 これは、検索ページの [検索インサイト](../../../search-pages-and-widgets/search-insights.md) ウィジェットで見られるリクエストと同じものです。

- ［**生の応答を表示**］ をクリックすると、検索応答文字列全体を表示します。 ここでは、レスポンスをクリップボードにコピーしたり、JSONファイルとしてダウンロードしたりすることができます。 これは、検索ページの [検索インサイト](../../../search-pages-and-widgets/search-insights.md) ウィジェットで見るのと同じ文字列です。

   ![Elasticsearchから返された生の応答文字列を表示します。](./creating-and-managing-search-blueprints/images/11.png)

- 各結果のスコアは、結果タイトルの左側に表示されます。 スコアをクリックすると、「スコア解説」が表示されます。

   ![結果のスコアの説明を表示します。](./creating-and-managing-search-blueprints/images/12.png)

- 結果を展開して、返されたドキュメントのすべてのフィールドを見るには、結果のタイトルの右側にある右向きの角括弧をクリックします。

   ![ドキュメントのフィールドを調べます。](./creating-and-managing-search-blueprints/images/13.png)

[いくつかの要素](./search-blueprints-elements-reference.md)は、手動で提供またはオーバーライドできる検索コンテキスト属性を読み取ります。 これらの要素を含むブループリントをテストするには、歯車アイコン (![Gear](../../../images/icon-cog3.png)) をクリックして、ブループリントのプレビュー検索に検索コンテキスト属性を追加します。 属性のキーと値のペアを入力し、 ［**完了**］ をクリックします。 この属性はブループリントのプレビューにのみ設定され、ブループリント自体とは一緒に保存されないことに注意してください。 これらの属性は、ページの検索で設定することができます。 詳しくは、[検索ブループリントを検索ページで使用する](./using-a-search-blueprint-on-a-search-page.md)を参照してください。

例えば、

1. [新しい語彙を追加し、](../../../../content-authoring-and-management/tags-and-categories.md) というカテゴリを持つ **管理用** を追加します。

1. [Webコンテンツ記事](../../../../content-authoring-and-management/web-content/web-content-articles.md)を2つ追加します。どちらもタイトル欄に **test** があることを確認します。 そのうちの1つを、作成したカテゴリーに関連付けます。

1. 新しいブループリントを作成し、条件要素である ［**ゲストユーザーに対してカテゴリ内のコンテンツを非表示**］ を追加します。 作成したカテゴリのアセットカテゴリIDが必要ですが、それはプレビューウィンドウで確認することができます。

1. プレビューで **administrative** を検索します。 Webコンテンツのドキュメントをカテゴリで展開し、 `assetCategoryId` (例：43013)を見つけます。

1. 要素の設定にあるIDを使用します。

1. プレビューサイドバーの「**属性**」 を開き、次のように入力します。

   キー:  `user.is_signed_in`。

   値:  `false`

1. **完了** をクリックし、 **テスト** の検索を入力します。

これで、未分類のWebコンテンツだけが返されるようになりました。 もう1つは、検索ユーザーがゲストであるかのように検索を動作させる検索コンテキスト属性のため、非表示になっています。

この例では、コンテキスト変数 `user.is_signed_in`を読み込むElementを使用しています。 手動で値を設定することで、既存の値を上書きし、ブループリントで特定の動作を示すことができます。 値はすでに検索コンテキストに存在するため、手動での設定は任意です。 その他の要素では、通常の検索リクエストのコンテキスト内に存在しないカスタムパラメータが必要です。 プレビューサイドバーからブループリントをテストする場合でも、検索ページで使用するためにブループリントを設定する場合でも、要素/ブループリントが正しく機能するように、これらを手動で検索コンテキストに渡す必要があります。

## 次のステップ

- [検索ブループリントを検索ページで使用する](./using-a-search-blueprint-on-a-search-page.md)
