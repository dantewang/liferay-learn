# データベースの剪定によるアップグレードの高速化

データ量が多いほど、データのアップグレードに時間がかかります。 不要なサイトデータは、よくあることです。 データベースから不要なデータを削除することで、アップグレード処理のパフォーマンスを向上させることができます。

例えば、サイトでは、ウェブコンテンツの記事やドキュメント、メディアファイルの未使用版が多数保存されている場合があります。 改訂が終わって、中間の改訂が必要ない場合は、安全に削除することができます。 これにより、省スペース化とアップグレード時間の短縮を実現しています。

ここでは、データベースの剪定に関するトピックを紹介します：

* 重複するWeb コンテンツストラクチャーのフィールド名を削除する
* 未使用のオブジェクトの検索と削除
* プルーニングされたデータベースのコピーを使用してテストする

## 廃止されたデータの削除

データベースに、廃止されたデータや廃止された機能から残ったデータが含まれている可能性があります。 どちらも簡単に削除できます。

{bdg-secondary}`データクリーンナップツールは7.3+で使用可能です。 Data Removal tool available 7.4+`

1. 廃止されたモジュールのデータを削除するには、[データクリーンアップ](../reference/data-cleanup.md)ツールを使用します。

1. 使用可能なモジュールから古いデータを削除するには、[データ削除](../reference/data-removal.md)ツールを使用します。

## 重複するWeb コンテンツストラクチャーのフィールド名を削除する

ウェブコンテンツマネジメントを多用されている方は、ユニークなフィールド名を持たない構造を持っているかもしれません。 アップグレード前に、重複するフィールド名を検索して削除する。 以前、Liferay Portal 6.2にアップグレードした際に、この作業をスキップした場合、このエラーが発生します：

```
19:29:35,298 ERROR [main][VerifyProcessTrackerOSGiCommands:221] com.liferay.portal.verify.VerifyException: com.liferay.dynamic.data.mapping.validator.DDMFormValidationException$MustNotDuplicateFieldName: The field name page cannot be defined more than once
com.liferay.portal.verify.VerifyException: com.liferay.dynamic.data.mapping.validator.DDMFormValidationException$MustNotDuplicateFieldName: The field name page cannot be defined more than once
```

このエラーが発生した場合は、Liferay Portal 6.2の以前のバックアップにロールバックし、重複するフィールド名を検索して削除してください。

## 未使用のオブジェクトの削除

データベースには、使用されていないオブジェクトのデータが残っている場合があります。

1. UIや、データベースで`SELECT`クエリを使用して他の未使用オブジェクトを特定し、UI、 [スクリプト コンソール](../../../system-administration/using-the-script-engine/running-scripts-from-the-script-console.md)を介したAPI、または作成したポートレットのいずれかでオブジェクトを削除します。

```{warning}
LiferayのUIまたはAPIはLiferay DXPのオブジェクト間の関係を考慮しているため、データの操作にはLiferayのUIまたはAPIのみを使用してください。 データベースでSQLを直接使用してレコードを削除しないでください。 SQLがオブジェクトの関係を見失い、オブジェクトが孤立し、パフォーマンスの問題が発生する可能性があります。
```

次に、よくある未使用品のチェックポイントを紹介します。

### ラージ／ポピュラーテーブルからのオブジェクト

テーブルの行は、Liferay DXPのオブジェクトにマッピングされます。 多くのレコードを持つ大きなテーブルには、多くの未使用のオブジェクトが含まれている可能性があります。 テーブルサイズとテーブルあたりのレコード数が大きくなるほど、アップグレードにかかる時間は長くなります。

このようなテーブルに関連する未使用のオブジェクトを見つけ、削除することで、アップグレード時間を短縮することができます。 Liferayのバックアップからデータをインポートすることで、貴重なテーブル情報を得ることができます。 データベースエンジンは、この情報をさまざまな方法で表示します。 例えば、データベースのインポートログは次のような感じでしょうか：

```
Processing object type SCHEMA\_EXPORT/TABLE/TABLE\_DATA

imported "LIFERAY"."JOURNALARTICLE" 13.33 GB 126687 rows

imported "LIFERAY"."RESOURCEPERMISSION" 160.9 MB 1907698 rows

imported "LIFERAY"."PORTLETPREFERENCES" 78.13 MB 432285 rows

imported "LIFERAY"."LAYOUT" 52.05 MB 124507 rows

imported "LIFERAY"."ASSETENTRY" 29.11 MB 198809 rows

imported "LIFERAY"."MBMESSAGE" 24.80 MB 126185 rows

imported "LIFERAY"."PORTALPREFERENCES" 4.091 MB 62202 rows

imported "LIFERAY"."USER\_" 17.32 MB 62214 rows

...
```

データベースのインポート例では、いくつかの項目が目立ちます：

* `JOURNALARTICLE` テーブルは、データベースサイズの98%を占めています。
* `RESOURCEPERMISSION` の記録が多く残っています。
* `PORTLETPREFERENCES` のレコードがたくさんあります。

目立つテーブルに関連する未使用のオブジェクトを検索し、LiferayのAPIを使用して(例えば、 [スクリプトコンソール](../../../system-administration/using-the-script-engine/running-scripts-from-the-script-console.md)を使用して）、不要なオブジェクトを削除します。

### チェックすべき共通のオブジェクトタイプ

特定のオブジェクトの種類によっては、未使用のオブジェクトがあるかどうかをチェックする必要があります。 ここでは、それらをチェックする理由を説明します：

* それらを削除することで、関連する未使用のオブジェクトが解放される
* 持っておく価値のないバージョン物かもしれない

これらのオブジェクトの種類を確認します：

* **サイト**: 不要なサイトを削除します。 サイトを削除すると、それに関連するオブジェクトが削除されます：
  * レイアウト
  * ポートレットプリファレンス
  * ファイルエントリ(ドキュメントライブラリオブジェクト）
  * アセットエントリー
  * タグ
  * ボキャブラリー、カテゴリー
  * Expando フィールドとその値
  * `ResourcePermission` オブジェクト
  * その他、サイト特有のものすべて

* **インスタンス**: 未使用のインスタンスは稀ですが、階層で最も高いオブジェクトなので、そのオブジェクトを削除するとアップグレードがかなり最適化されます。 インスタンスを削除すると、そのインスタンスに関連するこれらのオブジェクトが削除されます：
  * サイト(およびその関連コンテンツすべて）
  * ユーザー
  * ロール
  * 組織
  * Global `ResourcePermission` objects

* **ウェブコンテンツの中間バージョン** Liferay DXPは、何らかの変更(翻訳を含む）の後、新しいウェブコンテンツのバージョンを生成します。 不要なバージョンの削除を検討する。 特に、削除されたバージョンに固有の画像ファイルなどのオブジェクトがある場合は、かなりの空き容量になる可能性があります。 詳細は、[Example: Removing Intermediate Journal Article Versions](./example-removing-intermediate-journal-article-versions.md)を参照してください。

* **ドキュメントバージョン**: Journal Articlesと同様に、中間ドキュメントバージョンが不要な場合は削除してください。 これにより、データベースとファイルシステムの両方のスペースを節約することができます。

* **レイアウト：** レイアウトはサイトページであり、ポートレットプリファレンス、パーミッション、アセット、レーティングなどの他のエンティティに関係するため、アップグレードのパフォーマンスに影響を与えます。 不要なレイアウトを削除する。

* **Roles**: 不要なRolesを削除します。 それらを削除すると、関連する`ResourceBlockPermission`オブジェクトと`ResourcePermission`オブジェクトも削除されます。

* **ユーザー** アクティブでなく、不要になったユーザーを削除する。

* **Vocabularies**: 未使用のボキャブラリーを削除します。 なお、語彙を削除すると、そのカテゴリも削除される。

* **孤児データ**: 何にも繋がっていない未使用のオブジェクトがないか確認する。 次にいくつかの例を示します。
  * `DLFileEntries` ファイルシステムデータがない状態です。
  * 存在しないロール、レイアウト、ユーザー、ポートレットインスタンスなどに関連付けられている`ResourcePermission`オブジェクト。
  * `PortletPreference` もう存在しないポートレットやレイアウトに関連するオブジェクトです。 これは、多くのポートレットが埋め込まれた環境でよくあることです。 これらのポートレットインスタンスは、ライフサイクルが異なり、ポートレットがテンプレートから削除されても、削除されることはありません。

中間オブジェクトバージョンの削除例については、[例：ジャーナル記事の中間バージョンの削除](./example-removing-intermediate-journal-article-versions.md)を参照してください。

## ステージングされた変更を公開し、ステージングをオフにする

ローカル/リモートステージングを有効にしていて、ステージングサイトにコンテンツやデータを保存している場合、 [](../../../site-building/publishing-tools/staging/configuring-remote-live-staging.md) をライブサイトに公開します。 この手順を省略した場合、最後の公開日以降に変更されたコンテンツがわからないため、アップグレード後に完全公開を実行(または手動で変更を公開）する必要があります。 最終的なパブリッシュが終わったら、アップグレードの前にステージングをオフにします。

次に、その刈り込まれたデータベースでインスタンスをテストします。

## プルーニングされたデータベースのコピーを使用してテストする

削除した対象物に関連する問題を発見し、解決する。 これは、オブジェクトが誤って削除された場合や、他のコンテンツに影響する場合に備えて、重要なステップです。 問題を解決できない場合は、いつでも本番用データベースの新しいコピーのプルーニングを再開することができます。

## 追加情報

* [例：ジャーナル記事の中間バージョンの削除](./example-removing-intermediate-journal-article-versions.md)