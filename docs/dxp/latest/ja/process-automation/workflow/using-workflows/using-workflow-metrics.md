# ワークフローメトリクスの使用

> サブスクリプション

```{warning}
この機能はElasticsearchでのみ動作します(../../../using-search/installing-and-upgrading-a-search-engine/solr/solr-limitations.md).
```

_ワークフローメトリクス_により、特定のワークフローイベントを完了するために費やされた時間についての洞察が提供されます。 これを使用するには、ワークフロープロセスのイベントに期限を設定します。 これらの期限設定は、SLA（サービスレベルアグリーメント）と呼ばれます。 定義すると、ワークフローレポートによって、SLAへの準拠が測定されます。 これは、ワークフローの参加者とワークフロー項目を送信するユーザーの間の契約のようなものです。 _ワークフローレポート_には、各ワークフロー項目のSLAステータス（期限内または期限切れ）を含む、SLAが設定されたすべてのプロセスのデータが表示されます。

```{important}
* * SLAが設定されたワークフローの編集：* SLAが定義されたワークフローを編集すると（ノードの削除、タスク名の編集など）、ワークフロー/SLAパイプラインに既にある項目のSLAが無効になる場合があります。

* *アクティブなプロセスに対するSLAの作成または編集：*項目が既にワークフロープロセスにある場合にSLAの期間を編集したり、新しいSLAを定義すると、現在ワークフローにあるすべてのインスタンスが再計算されます。 完了したワークフローインスタンスは再計算されません。
```

## 前提条件

_ワークフローメトリクス_を使用するには、Elasticsearchを使用してDXPデータにインデックスを付ける必要があります。 詳細は、[Elasticsearchのインストール](../../../using-search/installing-and-upgrading-a-search-engine/elasticsearch/installing-elasticsearch.md)を参照してください。

## SLAの追加

SLAを追加するには

1. グローバルメニューでは、 _［アプリケーション］_ &rarr; _［ワークフロー］_ &rarr; _［メトリクス］_に移動します。
1. プロセスのタイトルをクリックします。
1. プロセスに対するSLAがない場合は、そのことを示す警告メッセージが表示されます。 警告メッセージの_［Add a new SLA］_リンクをクリックして、新しいSLAフォームに直接アクセスします。

   または、オプション（![Options](../../../images/icon-options.png)）メニューをクリックし、_［SLA Settings］_を選択します。

   ![メトリクスアプリケーションからワークフロー定義にSLAを追加します。](./using-workflow-metrics/images/01.png)

1. SLA画面で、_追加_ボタン（![Add](../../../images/icon-add.png)）をクリックします。
1. 新しいSLAフォームで、SLAに名前と説明を付けます。
1. 次の3つを指定して、SLAの期間を定義します。

    * **Start**：Enters Task: Review
    * **Pause**: On Task: Update
    * **Stop**: Process Ends: Approved

1. SLAの期間（つまり、期限）を定義します。 2つの時間ボックスの少なくとも1つに入力します。

    * **Days:** 1
    * **Hours:** 00:00

    ![SLAの例](./using-workflow-metrics/images/03.png)

1. _［Save］_ をクリックします。

![SLA画面からSLAを管理します。](./using-workflow-metrics/images/02.png)

### 有効な開始および停止イベント

ワークフロータスクは、SLAの開始または終了パラメーターとして使用できます。

項目がここで定義されたイベントに到達すると、SLAタイマーがカウントを開始します。 次のオプションから選択します。

| 開始イベント    | 説明                                                                        |
|:--------- |:------------------------------------------------------------------------- |
| 開始ノード     | _作成された_ノードに入るとSLAタイマーが起動します。                                              |
| タスクへのエントリ | SLAクロックは、ワークフローがタスクに移行したときに開始されます。                                        |
| タスクの終了    | SLAクロックは、ワークフローがタスクから移行したときに開始されます。 例えば、 _レビュー_タスクを終了した時点でSLAタイマーが開始されます。 |

項目が定義されたSLA期間（期限）の前に停止イベントに到達した場合、その項目はSLAに従って_期限内_となります。 指定した時間内に停止イベントに到達できなかった場合、_期限切れ_となります。 SLAの停止イベントとして機能するタスクを定義する場合は、次のオプションから選択します。

| 停止イベント    | 説明                                              |
|:--------- |:----------------------------------------------- |
| タスクへのエントリ | SLAクロックは、ワークフローがタスク（ _アップデート_タスクなど）に移行すると停止します。 |
| タスクの終了    | SLAクロックは、ワークフローがタスク（ _レビュー_タスクなど）から移行すると停止します。  |
| 終了ノード     | _承認された_ノードに入るとSLAタイマーが停止します。                    |

［一時停止］フィールドは、時間のカウントを停止する必要があるワークフローのイベントを定義します。 Single Approverワークフローの場合、項目が更新タスクにあるときにSLAタイマーを一時停止することを選択できます。 SLAは、開始ノードと終了ノードの間にある任意のタスクで一時停止でき、SLAを一時停止する必要があるときにノードを設定することによって定義します。 _ワークフロー項目が指定されたノードにある間、SLAタイマーは一時停止されます_ 。

### 期間

| 単位時間 | 説明                                                                                       |
|:---- |:---------------------------------------------------------------------------------------- |
| 日    | 日数は整数で入力します。 36時間などの場合は、_［Hours］_フィールドと組み合わせて使用します。この場合は、 1日と12時間と表現します。                 |
| 時間   | 時間数と分数を入力します。 _［Hours］_ボックスの値は_23:59_を超えてはいけません。 期間が1日を超える場合は、_［Days］_フィールドと組み合わせて使用します。 |

## SLAジョブ間隔の設定

メトリクスの再計算の時間間隔は、_SLAジョブ間隔_と呼ばれます。 デフォルト値は1分です。 デフォルト値を変更するには、

1. グローバルメニュー（![Applications Menu](../../../images/icon-applications-menu.png)）から、［システム設定］アプリケーションに移動し、［ワークフロー統計情報］エントリーを開きます。

2. ［SLAジョブの確認間隔］の設定値を変更し、_［保存］_をクリックします。

または、

1. 以下の設定ファイルを作成します

   ```
   com.liferay.portal.workflow.metrics.internal.configuration.WorkflowMetricsConfiguration.config
   ```

2. 以下のような内容を指定します。

   ```properties
   checkSLAJobInterval="1"
   ```

3. `［Liferay Home］/osgi/configs`に配置します。

ワークフロー統計情報データが検索エンジンから読み取られ、メトリクスが計算されます。 間隔の値を設定するときは、次の競合するパフォーマンスの懸念を考慮してください。

- メトリクスの再計算イベントの間隔が長いほど、再計算のたびに読み取られる検索ドキュメントの数が多くなります。
- メトリクスの再計算イベントの間隔が短いほど、検索エンジンへの読み取り要求の頻度が高くなります。

## ワークフロー統計情報のインデックスの再構築

Liferay DXPの _インデックス再構築_アクションは、マッピングファイルに基づいた検索インデックスを完全に削除し、その後再作成します。 メトリクスもデータベースに保存されるため、インデックスを再構築するときにデータが失われる危険はありません。 Liferay 7.3でワークフローメトリクスのインデックスを再作成するには

1. メトリクスアプリケーションから、オプションメニュー（![Options](../../../images/icon-options.png)）を開き、_［Settings］_をクリックします。

2. 次に、［ワークフローのインデックス操作］画面で、［ワークフローのインデックス］エントリの_［すべてインデックスを再構築］_をクリックします。

   このオプションは、ワークフロー統計情報アプリケーションのすべてのインデックスに作用します。 より詳細なオプションも利用できます。 複数の仮想インスタンスがある場合は、各仮想インスタンスのワークフローメトリクスのインデックスを個別に作成する必要があります。

Liferay 7.2では、ワークフローメトリクスは検索管理パネル（コントロールパネル &rarr; 構成 &rarr; 検索）から再インデックス化されます。

[検索エンジン](../../../using-search/installing-and-upgrading-a-search-engine/installing-a-search-engine.md)を最初に設定する際およびアップグレードするたびに、ワークフロー統計情報のインデックス再構築が必要です。 経験則として、Liferay DXPのメインの検索インデックスが再構築されるたびに、ワークフロー統計情報のインデックス再構築が必要です。

ワークフロープロセスの全体的なメトリクスから、ワークフロー内の単一項目の詳細まで、新しいワークフロー統計情報機能を使用して、Liferay DXPでの_作業にかかる時間_を把握できます。

## 追加情報

* [Creating Tasks in the Workflow Designer](https://help.liferay.com/hc/articles/360028821932-Creating-Tasks-in-the-Workflow-Designer)
* [ワークフロータスクノードのリファレンス](../developer-guide/workflow-task-node-reference.md)
