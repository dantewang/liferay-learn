# オーダー分割

{bdg-secondary}`liferay DXP 7.4 U84+/GA84+`

```{important}
オーダー分割は現在、リリース機能フラグの後ろにある。 詳しくは [ベータ版の機能と機能フラグ](https://learn.liferay.com/web/guest/w/dxp/system-administration/configuring-liferay/feature-flags#release-feature-flags) をお読みください。
```

1つの注文に複数の製品ラインがあったり、異なるサプライヤーから製品が提供されることもある。 このような場合、注文を独立したサブオーダーに分割することができます。

注文の分割は、注文項目のカタログに基づいて、顧客の注文を1つまたは複数のサプライヤーの注文に分割します。 サプライヤーの役割と連動している。 詳細は [サプライヤーの役割](../suppliers/supplier-role.md) を参照。

## 注文分割オブジェクトアクションの作成

注文分割オブジェクト・アクションを作成するには、2つの方法がある。 最初の方法は、コマース・オーダー・システム・オブジェクトに手動でオブジェクト・アクションを作成することです。 もう1つの方法は、事前に設定されたオブジェクトアクションを自動的に作成するコマースヘルスチェックを使用することです。

### 注文分割オブジェクトアクションを手動で作成する

1. グローバルメニュー(![グローバルメニュー](../../images/icon-applications-menu.png))を開き、 **コントロールパネル** &rarr; **オブジェクト** に移動します。

1. [コマースオーダー]を選択し、[アクション]をクリックします。

1. **追加**(![追加](../../images/icon-add.png))をクリックします：

   **アクション名：** splitOrderByCatalog

   **アクション名：** splitOrderByCatalog

1. アクションを有効にするには、 **Active** トグルを使用します。

1. **アクションビルダー** タブをクリックします。

1. [Trigger]で、ドロップダウンから[On Order Status Update]を選択します。

1. 「条件」でトグルを有効にし、次の式を入力する。

   各注文ステータスは整数に対応する。 異なるオーダーステータスを使用したい場合は、以下のいずれかの整数を使用する：

   | 注文ステータス | 整数値 |
   | :------ | :-- |
   | 公開      | 2   |
   | 処理中     | 6   |
   | 申請中     | 1   |
   | 処理中     | 10  |
   | 出荷済み    | 15  |
   | 完了      | 0   |
   | キャンセル済み | 8   |
   | 一部発送済み  | 14  |
   | 申請済み    | 20  |

   エクスプレッション・ビルダーを使用して、注文の分割を特定の注文タイプまたはチャネルに制限することもできます。 下記の例をご参照ください。

   `orderTypeId = 12345 AND channelId = 67890 AND orderStatus = 10`

   この式は、チャネル `67890` から注文タイプ ID `12345` の注文が処理ステータスに移行すると、その注文をすべて分割する。

1. [Action（アクション）]で、ドロップダウンから[**Split Order by Catalog**（カタログによる注文の分割）]を選択します。

1. ［**保存**］をクリックします。

### ヘルスチェックを使用した注文分割オブジェクトアクションの作成

また、商取引注文システムオブジェクトに関連付けられたオブジェクトアクションを作成するために、ヘルスチェックを実行することもできます。

1. **グローバルメニュー**( [グローバルメニュー](../../images/icon-applications-menu.png) )を開き、 **Commerce** &rarr; **Health Check** に移動します。

1. **カタログアクションによるオーダーの分割** ヘルスチェックを検索します。

1. **問題の修正** をクリックします。

   ![Create the commerce order object action automatically using the health check.](./order-splitting/images/01.png)

   これは、コマース受注システムオブジェクトのオブジェクトアクションを作成します。 ヘルスチェックで注文を作成した場合、注文分割アクションは無効になります。 作動させる、

1. ![グローバルメニュー](../../images/icon-applications-menu.png))を開き、 **コントロールパネル** &rarr; **オブジェクト** に移動します。

1. **コマースオーダー** を選択し、 **アクション** をクリックします。

1. すでにオブジェクト・アクションが作成されているはずだ。 それを選択し、 **Active** トグルを使ってアクションを有効にする。

これにより、異なるカタログの商品を含むすべての注文の分割が可能になります。

## オーダー分割のコンセプト

### お客様のご注文

顧客からの注文は、複数のカタログの商品を含む。 異なるカタログから2つの商品を注文した場合、 **注文済み** ページには1つの項目として表示されます。 これが顧客の注文だ。 この注文は、 **注文** ページから注文を受理したときにのみ分割されます。

### サプライヤーオーダー

**グローバルメニュー**(![グローバルメニュー](../../images/icon-applications-menu.png))を開き、 **Commerce** &rarr; **Orders** に移動します。 顧客注文の単一エントリが表示されます。

注文を選択し、 **Accept Order** をクリックします。 これでコマース注文オブジェクトのオブジェクトアクションが実行される。 Ordersページに戻ると、3つのエントリーが表示されます。1つは顧客オーダー、もう1つはサプライヤーオーダーです。 サプライヤーの注文は、それぞれのチャネルにリンクされている。

サプライヤーは、自分のチャネルにリンクされているサプライヤー注文のみを表示および管理することができます。 元の注文に3つの異なるカタログから3つの製品があった場合、合計4つのエントリがある（1つの顧客注文+3つのサプライヤー注文）。 顧客は、発注済み注文ページでサプライヤの注文を見ることができません。

### オーダーレベル割引の分割

すぐに使える注文分割ルールを使用する場合、分割注文を履行するすべてのサプライヤに公平であるように、元の注文と比較したサプライヤ注文のパーセンテージ値を使用して、サプライヤ間で割引が分割されます。 これは、注文合計および小計に対する割引に適用されます。 特定注文商品の割引に変更はない。 下の図を参照：

![Discount is split using the percentage value of the supplier order in comparison to the original order.](./order-splitting/images/02.png)

元の注文の合計金額は100ドルで、10ドルの固定注文割引がある。 AとBの2つのサプライヤーに分割され、それぞれ25ドルと75ドルである。 割引は、当初の注文に対するサプライヤーの注文額の割合に基づいて、これら2つのサプライヤーで分割される。 ここで、サプライヤーAの注文額25ドルは、当初の注文額の25％を占める。 従って、サプライヤーAの注文は当初の25％の割引となる。

```{note}
上記の図は固定割引の場合のみ有効です。 パーセンテージ割引の場合、各サプライヤーの注文からパーセンテージが差し引かれる。 例えば、10％の割引がある場合、各サプライヤーの注文は10％の割引を受ける。
```

## 分割注文への対応

顧客から見れば、情報の見え方に変化はない。 サプライヤーの注文を分割後に「発注済み注文」画面から確認できるのは、管理者のみです。 顧客は自分が発注したオリジナルの注文だけを見ることができ、サプライヤーは自分のサプライヤーの注文だけを見ることができる。

サプライヤーオーダーの品目に対して行われた更新は、顧客オーダーの特定の品目にも同様に伝搬されます。 例えば、あるサプライヤーが注文を出荷し、そのうちの1つの出荷の追跡番号を更新した場合、その商品の顧客はその追跡番号を見ることができます。 注文のステータスが処理中の状態から一部出荷された状態になります。 サプライヤーの注文が両方とも納品されると、元の顧客の注文は完了する。

## 関連トピック

* [サプライヤー](../suppliers.md)
