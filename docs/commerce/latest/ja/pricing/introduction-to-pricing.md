# 価格の概要

Liferay Commerceでは、商品の価格を微調整するための価格設定システムを提供しています。 1つの商品SKUに対して複数の価格エントリを定義し、どのアカウント、アカウントグループ、チャネルが各価格を受け取る資格があるかを決定することができます。 同じSKUに複数の価格エンティティが存在する場合、Commerceの価格設定エンジンは、チャネルの顧客ごとにどのエンティティを使用すべきかを計算します。

以下の記事では、Commerceの価格設定の概要と、顧客の商品および注文価格の決定方法について説明します。

* [Commerceの価格設定システムのコンポーネント](#components-of-commerces-pricing-system)
* [Commerceが商品価格を計算する方法](#how-commerce-calculates-product-prices)
* [Commerceが注文価格を計算する方法](#how-commerce-calculates-order-prices)

```{note}
以下の概要では、Commerce Pricing Engine v2.0について説明しています。 このエンジンバージョンは、Commerce 3.0以降およびPortal/DXP 7.3以降で使用されているデフォルトのアルゴリズムです。 Commerce 2.1.x 以前のバージョンでは、デフォルトでCommerceの [Pricing Engine v1.0](#pricing-engine-v1-0-reference) が使用されます。 必要であれば、インスタンスに使用されている[価格設定エンジンのバージョンを変更する](#enabling-pricing-engine-v2-0-in-commerce-2-1-x)ことができます。
```

## Commerceの価格設定システムのコンポーネント

Commerceでは、すべての商品はカタログに保存されており、各カタログには、デフォルトの[基本価格表](#base-price-list)と[基本プロモーションリスト](#base-promotion-list)があります。 これらのリストは、カタログに含まれるすべての商品SKUの基本価格エントリを保存するために使用され、すべての顧客が利用できるようになっています。 [価格表](#price-lists) および [プロモーションリスト](#promotion-lists) を作成して、よりターゲットを絞った構成可能な価格エンティティを定義することもできます。 また、各エントリの一部として、数量に応じて商品の特別価格を設定する[価格レート](#price-tiers)を定義することができます。 最後に、価格エントリを上書きせずに適用される [割引](#discounts)を作成することができます。

### 基本価格表

基準価格表には、カタログに掲載されているすべての商品SKUの開始価格が保存されています。 これらのエントリは、各SKUに上書きが適用されていないときに使用される標準通貨と価格を設定します。 このリストは、すべてのカタログに対して自動的に作成され、すべてのアカウントとチャネルで利用できるようになっています。 詳細は、[商品の基本価格を設定する](./setting-a-products-base-price.md)を参照してください。

   ![基準価格表には、カタログに掲載されているすべての商品SKUの開始価格エントリが保存されています。](./introduction-to-pricing/images/02.png)

### 基本プロモーション表

基準プロモーション表には、カタログに掲載されているすべての商品SKUの基準プロモーション価格のエントリが保存されています。 SKUに適用されると、基本プロモーション価格エントリはすべての顧客に対して基本価格を上書きします。 このリストは、すべてのカタログに対して自動的に作成され、すべてのアカウントとチャネルで利用できるようになっています。 詳しくは[プロモーションの基本リストのリファレンス](./promoting-products/promotion-base-list-reference.md) を参照してください。

   ![基準プロモーション表には、カタログに掲載されているすべての商品SKUの基準プロモーション価格のエントリが保存されています。](./introduction-to-pricing/images/03.png)

### 価格表

カスタム価格表は、特定の商品の価格エントリを保存し、対象となる顧客のみが利用できるようになっています。 これらのリストは、基本価格表とは異なる通貨を使用し、カタログのすべての、または一部の商品を含むことができます。 価格表のエントリは、対象となる顧客のSKUの基本価格を上書きします。 また、[価格修飾子](./using-price-modifiers.md)を定義して、特定の価格エントリを変更することもできます。 詳細は、[価格表の作成](./creating-a-price-list.md)を参照してください。

   ![カスタム価格表を使用して、よりターゲットを絞った価格エントリを保存します。](./introduction-to-pricing/images/04.png)

### プロモーションリスト

カスタムプロモーションリストは、特定の商品の販売価格エントリを保存し、対象となる顧客のみが利用できるようになっています。 これらのリストは、基本価格表とは異なる通貨を使用し、手動で選択された商品のみが含まれます。 これを適用すると、対象となるユーザーに対してSKUの他の価格項目（基本価格、段階価格など）が上書きされます。 これらのリストでは、[価格修飾子](./using-price-modifiers.md)を定義して、特定の価格エントリを変更することもできます。 有効にされている場合は、元の価格とプロモーション価格、両方が商品ページに表示され、購入者が値下げを確認できます。 詳細は、[プロモーションの作成](./promoting-products/creating-a-promotion.md)を参照してください。

   ![カスタムプロモーションリストを使用して、ターゲットを絞った販売価格エントリを保存します。](./introduction-to-pricing/images/05.png)

### 価格レート

価格レートは、価格エントリ内に直接設定されていて、最小数量の要件を満たす注文に対する特定の価格を定義します。 これらの価格は、割引注文オプションとして顧客に表示されます。 詳細は、[価格レートを使う](./using-price-tiers.md)を参照してください。

### 割引

割引は、価格に上乗せして適用され、価格に影響を与えることなく変更されます。 これらは、既存の価格エントリ内で定義することもできますし、独立したエンティティとして作成し、商品、商品グループ、カテゴリー、送料、小計、合計を対象に使用することもできます。 詳細は、[割引の概要](./promoting-products/introduction-to-discounts.md)を参照してください。

   ![割引の作成は価格に上乗せして適用され、価格に影響を与えることなく変更されます。](./introduction-to-pricing/images/06.png)

## Commerceが商品価格を計算する方法

Commerceの価格設定アルゴリズムは、各価格設定コンポーネントがチャネル内のSKUの価格にどのように影響するかを決定します。 アルゴリズムが価格リクエストを受信すると、Commerceはまず、商品の*単価*と*プロモ価格*を計算します。 これらの価格は、チャネルの顧客に提供される*最終価格*を決定するために使用されます。
<!--TASK: Consider adding details about net/gross price types and how taxes are calculated-->

### SKUの単価を計算する

SKUの単価を計算する際、Commerceはまず、チャネルと顧客に適用される価格表を、その表の適合性に応じて検索します。

* 該当する価格表がある場合、Commerceはその価格エントリを商品SKUに対して検索します。

  * SKUのエントリがある場合、アルゴリズムは既存の価格修飾子のそのSKUのエントリを適用し、SKUの単価の合計を使用します。

  * SKUのエントリがない場合、アルゴリズムは既存の価格修飾子をSKUの基本価格表エントリに適用し、合計をSKUの単価に使用します。

* 該当する価格表がない場合、SKUの単価にはSKUの基本価格表のエントリが使用されます。

```{note}
このプロセスの間に、Commerceは該当するティア価格もチェックします。 ティア価格がある場合は、その価格が特定の数量のデフォルトの価格の代わりに使用されます。
```

### SKUのプロモ価格を計算する

SKUの単価を計算した後、CommerceはSKUのプロモ価格を計算します。 この計算は、2つの例外を除き、基本的には単価の計算プロセスと同じです：

* 該当するプロモーションリストにSKUの価格エントリがない場合、既存の価格修飾子が単価に適用され、合計がプロモ価格に使用されます。

* 該当するプロモーションリストがなく、基本プロモーションリストが0に設定されている場合、プロモ価格は0に設定されます。

### SKUの最終価格を計算する

単価とプロモ価格が算出されると、Commerceは2つの価格を比較し、より良い方を選択します。 そして、価格アルゴリズムは、適用可能なすべての割引を検索し、最適なSKU価格に適用します。 合計は、SKUの最終価格、つまり顧客が商品を購入するために使用される価格です。

## Commerceが注文価格を計算する方法

注文価格を計算する際、Commerceはまず送料を取得し、送料を対象とした割引を適用します。

次にCommerceは、注文に含まれるすべてのSKUの最終価格を加算し、小計を決定します。 小計を対象とした割引が適用されます。

最後に、Commerceは割引後の送料と割引後の小計を合計し、注文の合計金額を算出します。 合計を対象とした割引が適用されます。

## 価格設定エンジン v1.0 リファレンス

| 価格設定方法                   | 概要                                       | 基本価格のオーバーライドの有無 | 設定場所  | 適用者                                      |         適用対象         |
|:------------------------ |:---------------------------------------- |:---------------:|:----- |:---------------------------------------- |:--------------------:|
| 基本価格                     | 基本価格                                     |       なし        | 商品SKU | すべての購入者                                  |        商品SKU         |
| 基本プロモーション                | 値下げ価格                                    |       はい        | 商品SKU | すべての購入者                                  |        商品SKU         |
| 価格表（定価、プロモーション価格）        | 商品および購入者ごとの特別価格（または通貨）                   |       はい        | 価格表   | 選択された購入者（アカウント & アカウントグループ）              |       個々の商品SKU       |
| レート価格表（レート価格、プロモーションレート） | _バルク数量での_商品および購入者ごとの特別価格（または通貨）          |       はい        | 価格表   | 選択された購入者（アカウント & アカウントグループ）              |       個々の商品SKU       |
| 割引                       | 商品または購入者のグループの価格の変更（数量を制限でき、クーポンコードも使用可） |       いいえ       | 割引    | 選択された購入者（アカウント & アカウントグループまたは特定の資格を満たす人） | 商品のグループ（または個々の商品SKU） |

```{note}
Commerce Pricing Engine v1.0では、価格エントリには、SKU、標準価格、プロモ価格の3つのコンポーネントが含まれています。 v2.0では、それぞれが個別のエンティティとなっています。
```

![価格階層図](./introduction-to-pricing/images/01.png)

## Commerce2.1.xでのPricing Engine v2.0の有効化

デフォルトでは、Commerce 2.1.x以前のバージョンではCommerce Pricing Engine v1.0が使用されています。 以下の手順に従って、Commerce Pricing Engine v2.0を有効にします：

1. コントロールパネルを開き、 *［システム設定］* &rarr; *［コマース］* &rarr; *［価格］*に移動します。

1. 左パネルの*［コマース価格設定］*をクリックします。

1. *［価格計算のキー］*フィールドで`［v1.0］`を`［v2.0］`に置き換えます。

1. *［保存］*をクリックします。

Commerceは、Liferayインスタンス内のすべての価格計算にPricing Engine v2.0を使用するように更新されています。

## 追加情報

* [商品の基本価格を設定する](./setting-a-products-base-price.md)
* [価格表の作成](./creating-a-price-list.md)
* [商品を価格表に追加する](./adding-products-to-a-price-list.md)
* [価格レートを使う](./adding-products-to-a-price-list.md)
* [割引を作成する](./promoting-products/creating-a-discount.md)
