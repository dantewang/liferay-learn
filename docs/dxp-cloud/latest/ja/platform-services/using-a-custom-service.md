# カスタムサービスの使用

DXP Cloudでは、すぐに利用できる標準的なサービスだけでなく、より多くのサービスを実行することができます。 また、カスタムサービスを作成して展開し、DXP Cloudインフラストラクチャ内で新しいプロセスを実行することもできます。 DXP Cloud環境においてカスタムサービスの利用を希望されるお客様は、まず販売代理店にご連絡の上、この機能を有効にし、お客様の環境が適切にプロビジョニングされていることをご確認ください。

```{note}
カスタムサービスを追加するためには、十分なハードウェアリソースが用意されている必要があります。 プロビジョニングプロセス中にカスタムサービスに追加のリソースを割り当てることができます。
```

DXP Cloudは、サービスの基盤としてDockerイメージを使用しています。 これらのサービスをローカルで実行したい場合は、 [［install Docker］](https://docs.docker.com/get-docker/) をローカルシステムにインストールしてください。

詳しくは、 [［custom services limitations］](../reference/platform-limitations.md#custom-services) を参照してください。

## カスタムサービスの追加

次の手順を使用して、DXP Cloudのビルドに独自のカスタムサービスを追加します：

1. カスタムサービスをDockerイメージとして作成または検索します。 プロジェクトのワークスペースに直接追加したDockerfileを使用するか、 [［Docker Hub］](https://hub.docker.com/) などのパブリックリポジトリのイメージを使用できます。

1. サービス用の新しいディレクトリを他のサービスディレクトリ（たとえば `［liferay］` および `［データベース］`）と一緒に追加し、その中に `［LCP.json］` ファイルを含めます：

    ```
    ├── backup
    ├── ci
    ├── database
    ├── liferay
    ├── search
    ├── webserver
    └── myCustomService
        └── LCP.json
    ```

    このファイルに設定を追加する方法の詳細は、[LCP.jsonによる設定 ](../reference/configuration-via-lcp-json.md) を参照してください。

    ```{warning}
    新しいカスタムサービスでビルドをトリガーしても、新しいサービス用に十分なリソースがプロビジョニングされていない場合、他のサービスに割り当てられたリソースに干渉する可能性があります。

    LCP.jsonファイルで新しいサービスのメモリとCPUの割り当てを直接設定して、正しい量のハードウェアリソースを取得できるようにします。
    ```

1. カスタムサービスを適用する環境を`［LCP.json］`内で指定します。 これは、新しいサービス用にプロビジョニングしたリソースの数によって異なります。

    たとえば、ビルドを `［prd］` 環境にのみ適用するには、 `［LCP.json］`に以下のプロパティを追加します：

    ```json
    {
      "environments": {
          "prd": {
            "deploy": true
          }
      }
    }
    ```

    そのようなプロパティが指定されていない場合、デフォルトでは、サービスはすべての環境用のカスタムサービスを構築しようとします。

1. Dockerイメージを新しいサービスに適用します。 Dockerイメージの追加に使用する方法は、パブリックリポジトリにアップロードされたイメージを使用しているか、ローカルのDockerfileを使用しているかによって異なります。

    ***公開リポジトリからのDockerイメージを使用している場合：** イメージの名前を `［LCP.json］`内の `［イメージ］` プロパティに追加します：

      ```
      "image": "mydockerimages/myservice:1.0.0"
      ```

    ***ローカルのDockerfileを使用している場合：** カスタムサービスのディレクトリにDockerfileを追加します。 サービスがビルドされると、DockerfileからのDockerイメージがサービスのイメージとして自動的に選択されます。

      ```{note}
      Dockerfileは自動的にサービスのイメージとして使用されます。 その結果、LCP.jsonの "image "プロパティは無視されます。
      ```

1. これらの変更をバージョン管理のブランチにコミットします：

    ```bash
    git add my-custom-service/
    git commit -m "Add custom service"
    ```

1. ブランチをアップして、DXP Cloudで新規ビルドを開始してデプロイします。 ビルドのデプロイについては、 [DXP Cloud Deployment の概要](./overview-of-the-dxp-cloud-deployment-workflow#deploy) にあるデプロイの情報を参照してください。

変更を加えたCIで新しいビルドをトリガーしたら、DXP Cloudコンソールの ［**ビルド**］ 画面に移動して、ビルドを確認できます。 ［**サービス**］ の列にリストされているサービスには、他のサービスとの新しいサービスが含まれています。

このビルドをいずれかの環境にデプロイする場合（アクションメニューで[**ビルドを** にデプロイ]をクリックして）、その環境の ［**サービス**］ ページに移動して、そこにリストされているカスタムサービスを確認することもできます：

![新しい "customservice" は他のサービスと一緒にデプロイされます。](./using-a-custom-service/images/01.png)

## 追加情報

* [DXP Cloud デプロイメントワークフローの概要](../build-and-deploy/overview-of-the-dxp-cloud-deployment-workflow)
