# DXP CloudでのSSOの使用

顧客はSAML 2.0準拠のシングルサインオンIDプロバイダーを使用して、DXP Cloudプラットフォームに対してユーザーを認証できます。 このドキュメントでは、この統合を有効にするプロセスについて詳しく説明します。

SAMLを使用してSSOを実行するには、クライアント、サービスプロバイダー（SP）、アイデンティティプロバイダー（IdP）の3つのエージェントが必要です。 クライアントがサービスプロバイダーに接続しようとすると、サービスプロバイダーはクライアントをアイデンティティプロバイダーにリダイレクトします。 クライアントがIDプロバイダーによって認証された後、IDプロバイダーはクライアントの資格情報へのアクセスをサービスプロバイダーに許可します。

このシナリオでは、DXP Cloudはサービスプロバイダーとして機能します。 DXP Cloudにログインしようとしているお客様がクライアントです。 IDプロバイダーは、顧客が管理するエンタープライズディレクトリソリューションです。

## DXP CloudプロジェクトでSSOを有効にする

DXP CloudプロジェクトでSSOを有効にするには、次の手順を実行する必要があります：

1. [DXPクラウドチームへのIdPメタデータの提供](#provide-identity-provider-metadata-to-the-dxp-cloud-team)
1. [DXP Cloudチームは、提供されたIdPデータをインポートし、サービスプロバイダ（SP）メタデータを提供します。](#dxp-cloud-team-imports-provided-idp-data-and-provides-service-provider-metadata)
1. [Liferay DXP Cloud チームが提供する SP メタデータをインポートする。](#import-sp-metadata-provided-by-the-liferay-dxp-cloud-team)

### DXPクラウドチームへのIDプロバイダメタデータの提供

DXP CloudプロジェクトでSSOを有効にしたいクライアントは、次の情報を含む必要がある **［IdP］** システムのメタデータを提供する必要があります：

| Field                              | Description                                                                                                                   |
|:---------------------------------- |:----------------------------------------------------------------------------------------------------------------------------- |
| IdP発行者                             | ID発行者の名前。通常、 `EntityDescriptor` メタデータの `EntityID` 属性                                                                          |
| IdPシングルサインオンURL                    | SAML認証を受信するリクエストエンドポイント(例：<http://adfs.customer.com/saml/sso)>                                                                |
| IdP署名証明書                           | SAMLメッセージおよびアサーション署名へのIdPの公開鍵証明書                                                                                              |
| IdPシングルサインオンHTTPメソッド（リクエストバインディング） | 認証要求を受信するために顧客のIDプロバイダーによってサポートされるHTTPメソッド。 有効な回答は `POST` （デフォルト）と `GET`のみです。                                                 |
| 署名リクエスト                            | 顧客のIDプロバイダーに送信されたSAMLリクエストに署名する必要がある場合は、 `TRUE`に 設定します。 それ以外の場合は `FALSE`に設定します。                                               |
| 署名アルゴリズムのリクエスト（RSA）                | `Sign Requests` が `TRUE`に設定されている場合は、署名に使用されるアルゴリズムを提供します。 現時点では、SHA-1（非推奨）およびSHA-256をサポートしています。 署名リクエストが無効になっている場合、この設定は不要です。 |

#### ADFS固有の情報

Microsoft ADFSを使用するクライアントは、SAMLを使用してSSOを設定するために必要な次の設定に注意する必要があります。

| 項目              | 説明                                                                           |
|:--------------- |:---------------------------------------------------------------------------- |
| IdP発行者URI       | ［全般］タブの _フェデレーションサービス識別子_ にあり、デフォルト値は <http://domain/adfs/services/trust>です。 |
| IdPシングルサインオンURL | デフォルトは `/adfs/ls`です。 例： <http://adfs.example.com/adfs/ls/>                   |
| IdP署名証明書        | DERエンコードされたバイナリX.509証明書ファイル                                                  |

IdPメタデータが生成されたら、 [DXP Cloudチームでチケットを開きます](https://help.liferay.com/hc/)。 IdPメタデータは、XMLファイルまたはURLエンドポイント（<https://localhost:8080/c/saml/metadata> が基本例）のいずれかの形式で送信することができる。

### DXPクラウドチームは、提供されたIdPデータをインポートし、サービスプロバイダのメタデータを提供する。

その後、DXPクラウドチームは、以下のSPメタデータの値をクライアントに提供します。

| 項目                       | 説明                                                                       |
|:------------------------ |:------------------------------------------------------------------------ |
| アサーションコンシューマサービス（ACS）URL | DXP Cloudが受信したSAML応答。 これは常に <https://auth.liferay.cloud>からのアドレスサーバーになります |
| オーディエンスURL               | 顧客のIDプロバイダーにアクセスするために使用されるURL Liferay Cloud                              |

### Liferay DXP Cloud チームが提供する SP メタデータをインポートする。

DXP CloudチームからSPメタデータを受け取った後、IdPにSPメタデータの値を入力します。

## SSOの使用

SSOを有効にすると、適切なアイデンティティプロバイダーを持つユーザーがSSOを使用して認証を行うことができます。

```{warning}
ユーザーがSSOで初めて認証すると、そのユーザーアカウントが変更され、それ以降はSSOを使用して認証する必要があります。
```

SSOを使用してDXP Cloudにログインするには：

1. <https://console.liferay.cloud/login>に移動します。
1. ［_Login via SSO_］をクリックします 。

   ![ログインページ](./using-sso-with-dxp-cloud/images/01.png)

1. _［組織ID］_ フィールドに **［会社名］**を入力します。
1. ［ _続行_］をクリックします。

    ```{note}
    組織のSSOで既に認証されている場合は、次の手順を実行する必要がない場合があります。
    ```

1. _［Email Address］_ フィールドに **Email Address**を入力します。 これは、会社のデータベースまたはディレクトリサービス（LDAPやADFSなど）に保存されているメールアドレスと同じである必要があります。
1. _［Password］_ フィールドに **パスワード**を入力します。 これは、会社のデータベースまたはディレクトリサービスに保存されているメールアドレスに関連付けられているパスワードと同じである必要があります。
1. ［ _Log in_ ］をクリックします。

ログインすると、ユーザーはすべてのプロジェクトと環境を確認できます。

![プロジェクトページ](./using-sso-with-dxp-cloud/images/02.png)
